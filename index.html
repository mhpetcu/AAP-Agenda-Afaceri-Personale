<!doctype html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AAP - V2 (one-file)</title>

<!-- Fonturi -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Roboto&display=swap" rel="stylesheet" />

<style>
  :root {
    --bg: #f9f9f9;
    --text: #111;
    --card: #fff;
    --accent: #0b84ff;
    --muted: #6b6b6b;
    --red: #dc3545;
    --yellow: #ffb400;
    --green: #28a745;
  }
  body.dark {
    --bg: #0f1113;
    --text: #e7e7e7;
    --card: #131516;
    --accent: #66aaff;
    --muted: #9b9b9b;
    --red: #ff6b6b;
    --yellow: #ffcb66;
    --green: #48d07a;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: 'Roboto', system-ui, -apple-system, "Segoe UI", Arial;
    -webkit-font-smoothing: antialiased;
    padding: 16px;
    transition: background 0.25s, color 0.25s;
  }

  .container { max-width: 980px; margin: 0 auto; }

  /* Header */
  header.top { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
  .title { font-family:'Montserrat',sans-serif; margin:0; font-size:28px; }
  .sub { margin:0; color:var(--muted); font-size:0.95rem; }

  .dark-toggle {
    background:transparent;
    border:none;
    cursor:pointer;
    font-size:20px;
    padding:6px 8px;
  }

  /* Controls */
  .controls { display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
  .lists { display:flex; gap:8px; flex-wrap:wrap; }
  .list-btn {
    background:var(--card);
    border:1px solid rgba(0,0,0,0.06);
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-family:'Montserrat',sans-serif;
    font-weight:600;
  }
  .list-btn.active { background:var(--accent); color:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.08); }

  .tools { display:flex; gap:8px; align-items:center; }
  .tools input[type="search"] {
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #ddd;
    width:200px;
  }
  .tools select { padding:8px; border-radius:8px; }

  /* Layout */
  .main-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:start; }
  .card { background:var(--card); padding:14px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.04); }
  form { display:flex; flex-direction:column; gap:10px; }

  input[type="text"], input[type="time"], textarea, select {
    padding:10px; border-radius:8px; border:1px solid #ddd; background:var(--card); color:var(--text);
    font-size:1rem;
  }
  textarea { min-height:64px; resize:vertical; }

  .row { display:flex; gap:8px; }
  .row > * { flex:1; }

  .primary { background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
  .muted { background:transparent; border:1px solid rgba(0,0,0,0.06); color:var(--muted); padding:10px 12px; border-radius:8px; cursor:pointer; }

  /* Calendar */
  .calendar { position:absolute; left:16px; top:220px; width:320px; padding:12px; border-radius:10px; box-shadow:0 14px 40px rgba(0,0,0,0.12); background:var(--card); z-index:9999; display:none; }
  .calendar-head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .nav { background:transparent; border:none; font-size:20px; cursor:pointer; color:var(--accent); padding:4px 6px; }
  .calendar-title { font-weight:600; text-align:center; flex:1; }
  .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:10px; }
  .calendar-day { font-size:0.78rem; text-align:center; color:var(--muted); }
  .calendar-date { text-align:center; padding:8px; border-radius:8px; cursor:pointer; }
  .calendar-date:hover { background: rgba(0,0,0,0.04); }
  .calendar-date.selected { background:var(--accent); color:#fff; }

  /* List */
  #taskList { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:10px; padding-bottom:110px; } /* bottom padding so floater doesn't cover */
  .task { display:flex; justify-content:space-between; gap:12px; background:var(--card); padding:12px; border-radius:10px; box-shadow:0 8px 18px rgba(0,0,0,0.04); align-items:flex-start; }
  .task-info { flex:1; }
  .task-info p { margin:4px 0; }
  .badges { margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; }
  .badge { padding:4px 8px; border-radius:8px; color:#fff; font-size:0.8rem; }
  .urgent { background:var(--red); }
  .normal { background:var(--green); }
  .status-in { background:var(--yellow); color:#111; }
  .status-out { background:var(--green); }

  .deadline-text { margin-top:6px; font-weight:600; font-size:0.95rem; }
  .deadline-text.overdue { color:var(--red); }
  .deadline-text.soon { color:var(--yellow); font-weight:800; }

  /* Actions */
  .task-actions { display:flex; gap:8px; justify-content:flex-end; align-items:center; min-width:140px; }
  .task-actions button { background:transparent; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
  .task-actions .del { color:var(--red); }

  /* Floater centered and fixed at 50px from bottom; we also keep extra padding in task list to avoid overlap */
  .floater {
    position: fixed;
    bottom: 50px;
    left:50%;
    transform: translateX(-50%);
    background:transparent;
    border-radius:8px;
    padding:6px 10px;
    color:var(--muted);
    font-family:'Roboto',sans-serif;
    z-index:6000;
    pointer-events:none; /* non-interactive so it won't block clicks â€” safe for small label */
  }

  /* Responsive adjustments */
  @media(max-width:900px){
    .main-grid { grid-template-columns:1fr; }
    .calendar { position:relative; left:auto; top:auto; width:100%; margin-top:6px; display:none; }
    .tools input[type="search"]{ width:140px; }
  }
  @media(max-width:520px){
    .title { font-size:20px; }
    .list-btn{ padding:8px 10px; font-size:0.95rem; }
    .task { flex-direction:column; align-items:stretch; }
    .task-actions { justify-content:flex-end; width:100%; margin-top:8px; }
    .task-actions button { padding:8px 10px; }
  }

  /* small helper */
  .muted-text { color:var(--muted); font-size:0.95rem; }
</style>
</head>
<body>
  <div class="container">
    <header class="top">
      <div>
        <div class="title">AAP</div>
        <div class="sub">Agenda Afacerilor Personale â€” V2 (balanced)</div>
      </div>
      <button id="darkToggle" class="dark-toggle" aria-label="ComutÄƒ modul Ã®ntunecat">ðŸŒ“</button>
    </header>

    <section class="controls">
      <div class="lists" role="tablist" aria-label="Liste">
        <button class="list-btn active" data-list="personal" role="tab" aria-selected="true">Afaceri Interne</button>
        <button class="list-btn" data-list="work" role="tab" aria-selected="false">Afaceri Externe</button>
        <button class="list-btn" data-list="ops" role="tab" aria-selected="false">Afaceri OperaÈ›ionale</button>
      </div>

      <div class="tools" aria-hidden="false">
        <input id="searchInput" type="search" placeholder="CautÄƒ..." aria-label="CautÄƒ taskuri" />
        <select id="sortSelect" aria-label="SelecteazÄƒ sortarea">
          <option value="added">Data adÄƒugÄƒrii</option>
          <option value="deadline">Deadline</option>
          <option value="priority">Prioritate</option>
        </select>
      </div>
    </section>

    <main class="main-grid">
      <!-- Form -->
      <section class="card form-card" aria-labelledby="form-title">
        <form id="taskForm" autocomplete="off">
          <input id="title" type="text" placeholder="Ce ai de fÄƒcut?" required aria-required="true" />
          <textarea id="details" rows="2" placeholder="Detalii (opÈ›ional)"></textarea>

          <div class="row">
            <select id="priority" aria-label="Prioritate">
              <option value="normal">Prioritate: Normal</option>
              <option value="urgent">Prioritate: Urgent</option>
            </select>

            <select id="status" aria-label="Status">
              <option value="in">Status: ÃŽn curs</option>
              <option value="out">Status: Gata</option>
            </select>
          </div>

          <div class="row">
            <input id="deadline" type="text" placeholder="Deadline (dd/mm/yyyy)" readonly aria-label="Deadline (alege din calendar)" />
            <input id="deadlineTime" type="time" aria-label="Ora deadline" />
          </div>

          <!-- Calendar chenar (persistent la schimbare lunÄƒ) -->
          <div id="calendar" class="calendar" role="dialog" aria-label="Calendar" aria-hidden="true">
            <div class="calendar-head">
              <button id="prevMonth" class="nav" type="button" aria-label="Luna anterioarÄƒ">â€¹</button>
              <div id="calendarTitle" class="calendar-title">Luna An</div>
              <button id="nextMonth" class="nav" type="button" aria-label="Luna urmÄƒtoare">â€º</button>
            </div>
            <div id="calendarGrid" class="calendar-grid" role="grid"></div>
          </div>

          <div class="row">
            <button id="saveBtn" class="primary" type="submit">SalveazÄƒ task</button>
            <button id="clearBtn" type="button" class="muted">Golire</button>
          </div>
        </form>
      </section>

      <!-- List -->
      <section class="card list-card" aria-labelledby="list-title">
        <ul id="taskList" aria-live="polite"></ul>
      </section>
    </main>

    <div class="floater">by @mhpetcu</div>
  </div>

<script>
/* ===========================================================
   AAP V2 - single-file JS
   - 3 liste separate (personal, work, ops)
   - sort + filter live
   - calendar persistent on month change (doesn't auto-close on month change)
   - date display dd/mm/yyyy
   - overdue / due soon / done coloring
   - floater fixed at bottom:50px with padding to avoid overlap
   =========================================================== */

const STORAGE = { personal: 'tasks_personal_v2', work: 'tasks_work_v2', ops: 'tasks_ops_v2' };

// State
let currentList = 'personal';
let tasks = JSON.parse(localStorage.getItem(STORAGE[currentList])) || [];
let editIndex = null;

// DOM references
const listBtns = document.querySelectorAll('.list-btn');
const sortSelect = document.getElementById('sortSelect');
const searchInput = document.getElementById('searchInput');

const taskList = document.getElementById('taskList');
const taskForm = document.getElementById('taskForm');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');

const titleEl = document.getElementById('title');
const detailsEl = document.getElementById('details');
const priorityEl = document.getElementById('priority');
const statusEl = document.getElementById('status');
const deadlineEl = document.getElementById('deadline');
const deadlineTimeEl = document.getElementById('deadlineTime');

const calendar = document.getElementById('calendar');
const calendarGrid = document.getElementById('calendarGrid');
const calendarTitle = document.getElementById('calendarTitle');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');

const darkToggle = document.getElementById('darkToggle');

// Utils: date formatting/parsing
function formatDateDisplay(yyyy_mm_dd) {
  if(!yyyy_mm_dd) return '';
  const [y,m,d] = yyyy_mm_dd.split('-');
  return `${d}/${m}/${y}`;
}
function parseDateInput(display) {
  if(!display) return '';
  const parts = display.split('/');
  if(parts.length !== 3) return '';
  const [d,m,y] = parts;
  return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
}

// Dark mode persistence
darkToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  localStorage.setItem('aap_dark_v2', document.body.classList.contains('dark'));
});
if(localStorage.getItem('aap_dark_v2') === 'true') document.body.classList.add('dark');

// Switch lists
listBtns.forEach(b => b.addEventListener('click', () => {
  const target = b.dataset.list;
  if(target === currentList) return;
  currentList = target;
  listBtns.forEach(x => {
    x.classList.toggle('active', x.dataset.list === currentList);
    x.setAttribute('aria-selected', x.dataset.list === currentList ? 'true' : 'false');
  });
  tasks = JSON.parse(localStorage.getItem(STORAGE[currentList])) || [];
  editIndex = null;
  taskForm.reset(); deadlineEl.value=''; deadlineTimeEl.value='';
  renderTasks();
}));

// Save/load tasks
function saveTasks() {
  localStorage.setItem(STORAGE[currentList], JSON.stringify(tasks));
}

// Sorting compare
function compareTasks(a,b) {
  const c = sortSelect.value;
  if(c === 'added') return (a._addedAt||0) - (b._addedAt||0);
  if(c === 'deadline') {
    if(!a.deadline && b.deadline) return 1;
    if(a.deadline && !b.deadline) return -1;
    if(!a.deadline && !b.deadline) return 0;
    if(a.deadline < b.deadline) return -1;
    if(a.deadline > b.deadline) return 1;
    const ta = a.deadlineTime || '00:00', tb = b.deadlineTime || '00:00';
    return ta < tb ? -1 : ta > tb ? 1 : 0;
  }
  if(c === 'priority') {
    if(a.priority === b.priority) return 0;
    if(a.priority === 'urgent') return -1;
    return 1;
  }
  return 0;
}

// Render tasks (filter + sort)
function renderTasks() {
  taskList.innerHTML = '';
  const q = (searchInput.value || '').toLowerCase();
  const now = new Date();

  const visible = tasks.slice().sort(compareTasks).filter(t => {
    if(!q) return true;
    return (t.title||'').toLowerCase().includes(q) || (t.details||'').toLowerCase().includes(q);
  });

  if(visible.length === 0) {
    const li = document.createElement('li');
    li.className = 'task';
    li.innerHTML = `<div class="task-info"><p class="muted-text">Lista este goalÄƒ.</p></div>`;
    taskList.appendChild(li);
    return;
  }

  visible.forEach(task => {
    const li = document.createElement('li');
    li.className = 'task';

    const info = document.createElement('div');
    info.className = 'task-info';

    const title = document.createElement('p');
    title.textContent = task.title || '(fÄƒrÄƒ titlu)';
    title.style.fontWeight = 600;
    if(task.status === 'out') { title.style.textDecoration = 'line-through'; title.style.opacity = '0.7'; }
    info.appendChild(title);

    if(task.details) {
      const d = document.createElement('p');
      d.textContent = task.details;
      d.className = 'muted-text';
      info.appendChild(d);
    }

    // badges
    const badges = document.createElement('div');
    badges.className = 'badges';
    const pri = document.createElement('span');
    pri.className = 'badge ' + (task.priority === 'urgent' ? 'urgent' : 'normal');
    pri.textContent = task.priority === 'urgent' ? 'Urgent' : 'Normal';
    badges.appendChild(pri);

    const st = document.createElement('span');
    st.className = 'badge ' + (task.status === 'in' ? 'status-in' : 'status-out');
    st.textContent = task.status === 'in' ? 'ÃŽn curs' : 'Gata';
    badges.appendChild(st);

    info.appendChild(badges);

    // deadline
    if(task.deadline) {
      const dl = document.createElement('p');
      dl.className = 'deadline-text';
      const display = formatDateDisplay(task.deadline) + (task.deadlineTime ? ' ' + task.deadlineTime : '');
      dl.textContent = 'Deadline: ' + display;

      if(task.status === 'in') {
        const dlDT = new Date(task.deadline + 'T' + (task.deadlineTime || '23:59'));
        const diff = dlDT - now;
        const dayMs = 24*60*60*1000;
        if(dlDT < now) {
          dl.classList.add('overdue');
        } else if(diff <= dayMs) {
          dl.classList.add('soon');
          dl.style.color = 'var(--yellow)';
          dl.style.fontWeight = '800';
        }
      } else {
        dl.style.color = 'var(--green)';
      }
      info.appendChild(dl);
    }

    li.appendChild(info);

    // actions
    const actions = document.createElement('div');
    actions.className = 'task-actions';

    const editBtn = document.createElement('button');
    editBtn.textContent = 'EditeazÄƒ';
    editBtn.type = 'button';
    editBtn.addEventListener('click', () => {
      const idx = tasks.indexOf(task);
      if(idx >= 0) fillFormForEdit(idx);
    });
    actions.appendChild(editBtn);

    const delBtn = document.createElement('button');
    delBtn.textContent = 'È˜terge';
    delBtn.type = 'button';
    delBtn.className = 'del';
    delBtn.addEventListener('click', () => {
      const idx = tasks.indexOf(task);
      if(idx >= 0 && confirm('È˜tergi acest task?')) {
        tasks.splice(idx,1); saveTasks(); renderTasks();
      }
    });
    actions.appendChild(delBtn);

    li.appendChild(actions);
    taskList.appendChild(li);
  });
}

// Fill form for edit
function fillFormForEdit(i) {
  const t = tasks[i];
  editIndex = i;
  titleEl.value = t.title || '';
  detailsEl.value = t.details || '';
  priorityEl.value = t.priority || 'normal';
  statusEl.value = t.status || 'in';
  deadlineEl.value = t.deadline ? formatDateDisplay(t.deadline) : '';
  deadlineTimeEl.value = t.deadlineTime || '';
  saveBtn.textContent = 'ActualizeazÄƒ task';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Clear & set defaults
clearBtn.addEventListener('click', () => {
  taskForm.reset();
  deadlineEl.value = '';
  deadlineTimeEl.value = '';
  editIndex = null;
  saveBtn.textContent = 'SalveazÄƒ task';
});

// Submit
taskForm.addEventListener('submit', e => {
  e.preventDefault();
  const newTask = {
    title: titleEl.value.trim(),
    details: detailsEl.value.trim(),
    priority: priorityEl.value,
    status: statusEl.value,
    deadline: parseDateInput(deadlineEl.value),
    deadlineTime: deadlineTimeEl.value,
    _addedAt: editIndex !== null ? tasks[editIndex]._addedAt : Date.now()
  };
  if(!newTask.title) { alert('Titlul este obligatoriu'); return; }

  if(editIndex !== null) {
    tasks[editIndex] = newTask;
  } else {
    tasks.push(newTask);
  }
  saveTasks(); renderTasks();
  taskForm.reset(); deadlineEl.value=''; deadlineTimeEl.value=''; editIndex = null; saveBtn.textContent='SalveazÄƒ task';
});

// Search & sort handlers
searchInput.addEventListener('input', renderTasks);
sortSelect.addEventListener('change', renderTasks);

// Initialize tasks for current list
tasks = JSON.parse(localStorage.getItem(STORAGE[currentList])) || [];
renderTasks();

/* =======================
   Calendar logic (persistent)
   ======================= */
let calYear = (new Date()).getFullYear();
let calMonth = (new Date()).getMonth();
let calSelected = null;

function buildCalendar(y,m) {
  calendarGrid.innerHTML = '';
  calendarTitle.textContent = ['Ianuarie','Februarie','Martie','Aprilie','Mai','Iunie','Iulie','August','Septembrie','Octombrie','Noiembrie','Decembrie'][m] + ' ' + y;

  // weekday headers
  ['Lu','Ma','Mi','Jo','Vi','SÃ¢','Du'].forEach(w => {
    const el = document.createElement('div'); el.className='calendar-day'; el.textContent = w; calendarGrid.appendChild(el);
  });

  const first = new Date(y,m,1);
  let start = first.getDay() - 1; if(start < 0) start = 6;
  const daysInMonth = new Date(y,m+1,0).getDate();

  for(let i=0;i<start;i++){ const e = document.createElement('div'); calendarGrid.appendChild(e); }

  for(let d=1; d<=daysInMonth; d++){
    const cell = document.createElement('div'); cell.className='calendar-date'; cell.textContent = d;
    const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(calSelected === dateStr) cell.classList.add('selected');

    // click selects date but DOES NOT auto-close (user can still pick time)
    cell.addEventListener('click', ev => {
      ev.stopPropagation();
      calSelected = dateStr;
      deadlineEl.value = formatDateDisplay(dateStr);
      // keep calendar open so user can pick time or change month
      buildCalendar(y,m);
    });

    calendarGrid.appendChild(cell);
  }
}

// navigation
prevMonth.addEventListener('click', ev => {
  ev.stopPropagation();
  if(calMonth === 0){ calYear--; calMonth = 11; } else calMonth--;
  buildCalendar(calYear, calMonth);
});
nextMonth.addEventListener('click', ev => {
  ev.stopPropagation();
  if(calMonth === 11){ calYear++; calMonth = 0; } else calMonth++;
  buildCalendar(calYear, calMonth);
});

// toggle calendar on deadline click
deadlineEl.addEventListener('click', ev => {
  ev.stopPropagation();
  const isShown = calendar.style.display === 'block';
  calendar.style.display = isShown ? 'none' : 'block';
  calendar.setAttribute('aria-hidden', isShown ? 'true' : 'false');
  buildCalendar(calYear, calMonth);
  // position: on wide screens calendar is absolutely positioned; on narrow it becomes relative due to CSS
});

// document click closes calendar (unless click inside calendar or on deadline)
document.addEventListener('click', ev => {
  if(!calendar.contains(ev.target) && ev.target !== deadlineEl) {
    calendar.style.display = 'none';
    calendar.setAttribute('aria-hidden','true');
  }
});

// ESC closes calendar
document.addEventListener('keydown', ev => {
  if(ev.key === 'Escape') {
    calendar.style.display = 'none';
    calendar.setAttribute('aria-hidden','true');
  }
});

// initial calendar build
buildCalendar(calYear, calMonth);

/* Ensure when switching lists we save previous list tasks */
window.addEventListener('beforeunload', () => {
  saveTasks();
});

// If user switches list, save previous list automatically by listening to list button clicks
listBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    // save the previous list's tasks to storage before switching
    localStorage.setItem(STORAGE[currentList], JSON.stringify(tasks));
  });
});
</script>
</body>
</html>
